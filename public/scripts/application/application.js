/*
 * browse the non-minified code at
 * https://github.com/tambien/Ring
 */

$(function(){RING.initialize()});
var RING=function(){function a(){RING.width=d.width();RING.height=d.height();RING.camera.aspect=RING.width/RING.height;RING.camera.updateProjectionMatrix();RING.renderer.setSize(RING.width,RING.height)}function b(){$(window).resize(a);d.mousedown(function(){RING.removeHighlight()});d.click(c);$(document).bind("contextmenu",function(a){a.preventDefault()})}function c(a){a.preventDefault();if(2==a.which||3==a.which)return!1;var b=a.offsetX;a=a.offsetY;var c=new THREE.Vector3(2*(b/RING.width)-1,2*-(a/
RING.height)+1,1);g.unprojectVector(c,RING.camera);c=c.sub(RING.camera.position).normalize();new THREE.Ray(RING.camera.position,c);var e=-RING.camera.position.z/c.z,d=RING.camera.position.clone().add(c.multiplyScalar(e)),c=RING.tumblrCollection.where({visible:!0}),c=c.concat(RING.twitterCollection.where({visible:!0}));d.setZ(1);var f=[];_.forEach(c,function(a){a.view.particle.distanceTo(d)<a.get("size")&&f.push(a)});var h=-1E4,q;_.forEach(f,function(a){var b=a.view.particle.z;b>h&&(q=a,h=b)});q&&
q.clicked(b,a)}function e(){k||(requestAnimationFrame(e),RING.dev&&h.update(),RING.renderer.render(RING.scene,RING.camera),TWEEN.update())}var d,f=0,g,h,k=!0;return{initialize:function(){"#installation"===window.location.hash?(RING.installation=!0,RING.artistCount=26):(RING.installation=!1,RING.artistCount=14);d=$("#container");RING.$container=d;var c;try{c=!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){c=!1}c&&Modernizr.webaudio&&($("#noChrome").css({"z-index":-100,
opacity:0}),RING.camera=new THREE.PerspectiveCamera(70,4/3,1,1E4),RING.camera.position.set(0,0,1E3),RING.scene=new THREE.Scene,g=new THREE.Projector,RING.renderer=new THREE.WebGLRenderer({antialias:!0}),RING.renderer.sortObjects=!1,$("#canvas").append(RING.renderer.domElement),a(),c=THREE.ImageUtils.loadTexture("./images/Yellow_Outline.png"),c=new THREE.SpriteMaterial({map:c,useScreenCoordinates:!1,color:16777215}),RING.highlight=new THREE.Sprite(c),RING.highlight.position.x=-1E4,RING.highlight.position.y=
-1E4,RING.highlight.position.z=2,RING.highlight.scale.x=10,RING.highlight.scale.y=10,RING.scene.add(RING.highlight),RING.dev&&(h=new Stats,h.domElement.style.position="absolute",h.domElement.style.top="0px",h.domElement.style.right="0px",d.append(h.domElement)),b(),RING.tumblrCollection=new RING.TumblrCollection,RING.twitterCollection=new RING.TwitterCollection,RING.Particles.initialize(),RING.controls=new RING.Controls,RING.attractMode=new RING.AttractMode,RING.sound=new RING.Sound)},loaded:function(){f++;
2===f&&$("#loadingScreen").fadeTo(500,0,function(){$(this).css({"z-index":-100})})},pause:function(){k=!0},start:function(){k=!1;e()},removeHighlight:function(){$(".post").remove();RING.highlight.position.x=-1E4;RING.highlight.position.y=-1E4}}}();RING.dev=!1;RING.dontLoad=!1;RING.Util=function(){function a(){var a=4022871197,b=function(b){b=b.toString();var c;for(c=0;c<b.length;c++){a+=b.charCodeAt(c);var d=0.02519603282416938*a;a=d>>>0;d-=a;d*=a;a=d>>>0;d-=a;a+=4294967296*d}return 2.3283064365386963E-10*(a>>>0)};b.version="Mash 0.9";return b}var b=function(){return function(b){var c=0,f=0,g=0,h=1;0==b.length&&(b=[+new Date]);for(var k=a(),c=k(" "),f=k(" "),g=k(" "),l=0;l<b.length;l++)c-=k(b[l]),0>c&&(c+=1),f-=k(b[l]),0>f&&(f+=1),g-=k(b[l]),0>g&&(g+=1);var k=null,m=function(){var a=
2091639*c+2.3283064365386963E-10*h;c=f;f=g;return g=a-(h=a|0)};m.uint32=function(){return 4294967296*m()};m.fract53=function(){return m()+1.1102230246251565E-16*(2097152*m()|0)};m.version="Alea 0.9";m.args=b;return m}(Array.prototype.slice.call(arguments))}(),c=function(a){return~~a};return{random:b,choose:function(a){var d=c(a.length*b());return a[d]},shuffleArray:function(a){a=a.slice(0);for(var c,f,g=a.length;g;c=parseInt(b()*g),f=a[--g],a[g]=a[c],a[c]=f);return a},flipCoin:function(){return 0.5>
b()},randomInt:function(a,c){return~~(b()*(c-a)+a)},randomFloat:function(a,c){return a+b()*(c-a)},scale:function(a,b,c,g,h){return g+(a-b)/(c-b)*(h-g)},scaleInt:function(a,b,c,g,h){return~~(g+(a-b)/(c-b)*(h-g))},scaleLog:function(a,b,c,g,h){if(1>g||1>h)return console.error("the scaled to values must be at least 1"),a;g=Math.log(g);c=(Math.log(h)-g)/(c-b);return Math.exp(g+c*(a-b))},scaleExp:function(a,b,c,g,h){b=Math.log(b);c=(Math.log(c)-b)/(h-g);return(Math.log(a)-b)/c+g},abs:function(a){return 0>
a?-a:a},toInt:c,clip:function(a,b,c){return a<b?b:a>c?c:a}}}();RING.Particles=function(){function a(a,c,e,d){c={size:{type:"f",value:[]},ca:{type:"c",value:[]}};e={amplitude:{type:"f",value:1},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:THREE.ImageUtils.loadTexture(d)}};e.texture.value.wrapS=e.texture.value.wrapT=THREE.RepeatWrapping;a=new THREE.ShaderMaterial({uniforms:e,attributes:c,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,depthTest:!1,
transparent:!0,opacity:0.8});d=new THREE.Geometry;for(var f=0;f<b;f++){var g=new THREE.Vector3;g.x=-1E4;g.y=-1E4;g.z=RING.Util.randomFloat(-1,1);d.vertices.push(g)}a=new THREE.ParticleSystem(d,a);a.dynamic=!0;d=a.geometry.vertices;for(var f=c.size.value,g=c.ca.value,h=0;h<d.length;h++)f[h]=1,g[h]=new THREE.Color(16777215);RING.scene.add(a);return{system:a,attributes:c,uniforms:e}}var b=3E4,c,e,d,f=0,g,h,k,l=0,m,n,r,p=0;return{get:function(a){switch(a.get("style")){case "circle":var e=c.geometry.vertices[f];
a.set("particleIndex",f);f++;f%=b;return e;case "octagon":return e=m.geometry.vertices[p],a.set("particleIndex",p),p++,p%=b,e;case "circle_grad":return e=g.geometry.vertices[l],a.set("particleIndex",l),l++,l%=b,e}},initialize:function(){var b=a(c,e,d,"./images/Circle_large.gif");c=b.system;e=b.attributes;d=b.uniforms;b=a(g,h,k,"./images/Circle_Grad_large.gif");g=b.system;h=b.attributes;k=b.uniforms;b=a(m,n,r,"./images/Octogon_Grad_large.gif");m=b.system;n=b.attributes;r=b.uniforms},update:function(a){var b=
a.get("particleIndex"),d,f;switch(a.get("style")){case "circle":d=e;f=c;break;case "circle_grad":d=h;f=g;break;case "octagon":d=n;f=m;break;default:return}d.size.value[b]=a.get("size");d.ca.value[b]=a.get("color");f.geometry.vertices[b].x=a.get("x");f.geometry.vertices[b].y=a.get("y");d.size.needsUpdate=!0;d.ca.needsUpdate=!0;f.geometry.verticesNeedUpdate=!0},updateSize:function(a){var b=a.get("particleIndex"),d;switch(a.get("style")){case "circle":d=e;system=c;break;case "circle_grad":d=h;system=
g;break;case "octagon":d=n;system=m;break;default:return}d.size.value[b]=a.get("size");d.size.needsUpdate=!0},updateColor:function(a){var b=a.get("particleIndex"),d;switch(a.get("style")){case "circle":d=e;system=c;break;case "circle_grad":d=h;system=g;break;case "octagon":d=n;system=m;break;default:return}d.ca.value[b]=a.get("color");d.ca.needsUpdate=!0},updatePosition:function(a){var b=a.get("particleIndex"),d;switch(a.get("style")){case "circle":attributes=e;d=c;break;case "circle_grad":attributes=
h;d=g;break;case "octagon":attributes=n;d=m;break;default:return}d.geometry.vertices[b].x=a.get("x");d.geometry.vertices[b].y=a.get("y");d.geometry.verticesNeedUpdate=!0},position:function(a,b,d,f){var k=a.get("particleIndex"),l;switch(a.get("style")){case "circle":attributes=e;l=c;break;case "circle_grad":attributes=h;l=g;break;case "octagon":attributes=n;l=m;break;default:return}a=a.get("visible")?TWEEN.Easing.Exponential.Out:TWEEN.Easing.Exponential.In;(new TWEEN.Tween({x:l.geometry.vertices[k].x,
y:l.geometry.vertices[k].y})).to({x:b,y:d},RING.Util.randomInt(500,800)).easing(a).onUpdate(function(){l.geometry.vertices[k].x=this.x;l.geometry.vertices[k].y=this.y;l.geometry.verticesNeedUpdate=!0}).onComplete(function(){f&&f()}).start()},makeInvisible:function(a){var b=a.get("particleIndex");switch(a.get("style")){case "circle":attributes=e;a=c;break;case "circle_grad":attributes=h;a=g;break;case "octagon":attributes=n;a=m;break;default:return}a.geometry.vertices[b].x=-5E3;a.geometry.vertices[b].y=
-5E3;a.geometry.verticesNeedUpdate=!0},positionInstant:function(a,b,d){var f=a.get("particleIndex");switch(a.get("style")){case "circle":attributes=e;a=c;break;case "circle_grad":attributes=h;a=g;break;case "octagon":attributes=n;a=m;break;default:return}a.geometry.vertices[f].x=b;a.geometry.vertices[f].y=d}}}();RING.Post=Backbone.Model.extend({defaults:{id:0,artist:"",text:"",timestamp:0,note_count:0,x:0,y:0,radius:0,theta:0,size:0,visible:!1,particleIndex:0,style:"circle",color:new THREE.Color(16777215)},superInit:function(a,b){this.set("radius",RING.Util.randomFloat(350,420));this.on("change:note_count",this.getSizeFromNoteCount);this.getSizeFromNoteCount();this.cid=this.get("id")},superLoaded:function(){this.getInitialPosition()},remove:function(){this.view.remove()},removeAll:function(){this.line&&RING.scene.remove(this.line);
RING.Particles.positionInstant(this,0<this.get("x")?1E4:-1E4,0<this.get("y")?1E4:-1E4)},getInitialPosition:function(){var a=RING.controls.get("startTime"),b=RING.controls.get("endTime"),c=new Date(this.get("timestamp"))-0,b=b-a;0<b&&(this.theta=a=2*(c-a)/b*Math.PI+Math.PI/2,this.set("theta",a),c=this.get("radius"),this.set({x:c*Math.cos(a),y:c*Math.sin(a),theta:a}))},getPositionFromTime:function(){if(this.get("visible")){var a=RING.controls.get("startTime"),b=RING.controls.get("endTime"),c=new Date(this.get("timestamp"))-
0,b=b-a;0<b&&(this.theta=a=2*(c-a)/b*Math.PI+Math.PI/2,this.set("theta",a),c=this.get("radius"),this.set({x:c*Math.cos(a),y:c*Math.sin(a),theta:a}))}},getSizeFromNoteCount:function(){var a=this.get("note_count")/10+1,b=0,b=20*Math.log(a)+5;this.set("size",b)},setTheta:function(a,b){this.theta=Math.atan2(b,a);this.set("theta",this.theta);this.set("radius",Math.sqrt(a*a+b*b))},clicked:function(a,b){this.view.createElement();this.view.$el.appendTo($("#container"));this.view.positionElement(a,b)}});
RING.Post.View=Backbone.View.extend({className:"post",superInit:function(){var a=_.throttle(this.position,500);this.listenTo(this.model,"change:x",a);this.listenTo(this.model,"change:y",a);this.listenTo(this.model,"change:color",this.setColor);this.listenTo(this.model,"change:size",this.setSize);this.listenTo(this.model,"change:visible",this.setVisible);this.particle=RING.Particles.get(this.model);RING.Particles.updateSize(this.model);this.$container=$("<div class='container'></div>").appendTo(this.$el)},
createElement:function(){},position:function(a){a.get("visible")&&RING.Particles.position(a,a.get("x"),a.get("y"))},setSize:function(a,b){RING.Particles.updateSize(a)},setColor:function(a){RING.Particles.updateColor(a)},clicked:function(){},remove:function(){},setVisible:function(a,b){b?(RING.controls.set("visiblePosts",RING.controls.get("visiblePosts")+1,{silent:!1}),RING.Particles.positionInstant(a,0<a.get("x")?1E4:-1E4,0<a.get("y")?1E4:-1E4),this.position(a,a.get("x"),a.get("y"))):(RING.controls.set("visiblePosts",
RING.controls.get("visiblePosts")-1,{silent:!1}),RING.Particles.position(a,0<a.get("x")?1E4:-1E4,0<a.get("y")?1E4:-1E4))},positionElement:function(a,b){var c={},e={};this.$el.find(".pointer").remove();var d=this.model.get("x"),f=this.model.get("y");0<d&&0<f?(c.left=RING.Util.toInt(a)-280,c.top=RING.Util.toInt(b),e.right="0px",e.top="0px",e.left="",e.bottom="",$(".top_right").clone().appendTo(this.$el)):0<d&&0>f?(c.left=RING.Util.toInt(a)-280,c.top=RING.Util.toInt(b)-500,e.right="0px",e.bottom="0px",
e.top="",e.left="",$(".bottom_right").clone().appendTo(this.$el)):0>d&&0<f?(c.left=RING.Util.toInt(a),c.top=RING.Util.toInt(b),e.left="0px",e.top="0px",e.bottom="",e.right="",$(".top_left").clone().appendTo(this.$el)):0>d&&0>f&&(c.left=RING.Util.toInt(a),c.top=RING.Util.toInt(b)-500,e.bottom="0px",e.left="0px",e.right="",e.top="",$(".bottom_left").clone().appendTo(this.$el));this.$el.css(c);this.$container.css(e);RING.highlight.position.x=this.model.get("x");RING.highlight.position.y=this.model.get("y");
RING.highlight.scale.x=1.6*this.model.get("size");RING.highlight.scale.y=1.6*this.model.get("size")}});RING.Tumblr=RING.Post.extend({initialize:function(a,b){this.superInit();this.set("style",RING.Util.choose(["circle_grad","circle"]));this.reblogs=[];this.get("reblogged_from")&&this.set("size",this.get("size")/2);this.view=new RING.Tumblr.View({model:this})},allLoaded:function(){this.superLoaded();this.origin=this.collection.get(this.get("reblogged_from"));this.connectReblogs();this.getReblogLevel();this.origin?this.listenTo(this.origin,"change:visible",this.originVisibility):(this.listenTo(RING.controls,
"change:startTime",this.getPositionFromTime),this.listenTo(RING.controls,"change:endTime",this.getPositionFromTime),this.on("change:visible",this.getPositionFromTime));this.systemNodes=[{v:new THREE.Vector3(this.get("x"),this.get("y"),0),t:this.get("theta"),r:this.get("radius")}];this.systemNodesTween=[];this.on("change:x",_.throttle(this.moveStartLine,100));this.on("change:y",_.throttle(this.moveStartLine,100))},allLoaded2:function(){this.origin?this.view.drawEdgeToOrigin():(this.positionReblogs(),
this.on("change:theta",this.thetaChange))},allLoaded3:function(){},originVisibility:function(a,b){b||this.set("visible",!1)},changeReblogLevel:function(a,b){this.origin.get("visible")&&(this.get("reblog_level")<=b?reblog.set("visible",!0):reblog.set("visible",!1))},makeReblogsVisible:function(a){_.forEach(this.reblogs,function(b,c){b.get("reblog_level")<=a?(b.set("visible",!0),b.makeReblogsVisible(a)):b.set("visible",!1)})},makeReblogsInvisible:function(a,b){b||_.forEach(a.reblogs,function(a,e){a.set("visible",
!1);a.makeReblogsInvisible(a,b)})},changeReblogLevel:function(a,b){var c=this.origin;c&&c.get("visible")&&(b>=this.get("reblog_level")?this.set("visible",!0):this.set("visible",!1))},getReblogLevel:function(){null===this.get("reblogged_from")?this.set("reblog_level",0):this.origin&&null===this.origin.get("reblogged_from")?this.set("reblog_level",1):this.set("reblog_level",2)},connectReblogs:function(){this.origin&&0>this.origin.reblogs.indexOf(this)&&this.origin.reblogs.push(this)},positionReblogs:function(){this.makeSystemNodes();
this.get("x");this.get("y");this.get("theta");for(var a=0,b=this.reblogs.length;a<b;a++){var c=this.reblogs[a];c.systemNodeIndex=RING.Util.randomInt(0,this.systemNodes.length);var e=this.systemNodes[c.systemNodeIndex],d=e.t+RING.Util.randomFloat(-0.1,0.1),f=RING.Util.randomInt(30,50)+e.r,e=f*Math.cos(d),f=f*Math.sin(d);rRadius=Math.sqrt(e*e+f*f);c.set({x:e,y:f,theta:d,radius:rRadius});c.positionReblogs()}},thetaChange:function(a,b){var c=b-this.previous("theta");this.repositionReblogs(c)},moveStartLine:function(){var a=
this.get("x"),b=this.get("y");this.systemNodes[0].r=this.get("radius");this.systemNodes[0].t=this.get("theta");this.systemNodesTween[0]&&this.systemNodesTween[0].stop();this.systemNodesTween[0]=(new TWEEN.Tween({x:this.systemNodes[0].v.x,y:this.systemNodes[0].v.y})).to({x:a,y:b},800).onUpdate(function(a,b){return function(){a.v.setX(this.x);a.v.setY(this.y);b.line&&(b.line.geometry.verticesNeedUpdate=!0)}}(this.systemNodes[0],this.view)).start()},repositionReblogs:function(a){this.moveLine(a);for(var b=
0,c=this.reblogs.length;b<c;b++){var e=this.reblogs[b],d=e.get("theta")+a,f=e.get("radius");e.set({x:f*Math.cos(d),y:f*Math.sin(d),theta:d});e.repositionReblogs(a)}},makeSystemNodes:function(){for(var a=this.reblogs.length,b=Math.floor(0.25*a),c=Math.ceil(0.75*a),c=Math.min(c,10),e=this.get("x"),d=this.get("y"),a=this.get("theta"),b=RING.Util.randomInt(c,b),c=0;c<b;c++){var f=a+RING.Util.randomFloat(-0.5,0.5),g=RING.Util.randomInt(30,50),e=g*Math.cos(f)+e,d=g*Math.sin(f)+d,f=Math.atan2(d,e),g=Math.sqrt(e*
e+d*d),h=new THREE.Vector3(e,d,0);this.systemNodes.push({t:f,r:g,v:h})}},moveLine:function(a){for(var b=1;b<this.systemNodes.length;b++){var c=this.systemNodes[b],e=c.v.x,d=c.v.y;c.t+=a;var f=c.r*Math.cos(c.t),g=c.r*Math.sin(c.t),h=this.view;this.systemNodesTween[b]&&this.systemNodesTween[b].stop();this.systemNodesTween[b]=(new TWEEN.Tween({x:e,y:d})).to({x:f,y:g},800).onUpdate(function(a,b){return function(){a.v.setX(this.x);a.v.setY(this.y);b.line&&(b.line.geometry.verticesNeedUpdate=!0)}}(c,h)).start()}this.view.line&&
(this.view.line.geometry.verticesNeedUpdate=!0)}});RING.Tumblr.lineMaterial=new THREE.LineBasicMaterial({color:268435455,opacity:0.2,linewidth:0.5,transparent:!0});
RING.Tumblr.View=RING.Post.View.extend({initialize:function(){this.superInit();this.listenTo(this.model,"change:visible",this.lineVisible)},lineVisible:function(a,b){this.lineTimeout&&clearTimeout(this.lineTimeout);this.lineTimeout=setTimeout(function(a,e){if(a.line){var d=e.origin.get("x"),f=e.origin.get("y");if(b){RING.scene.add(a.line);for(var g=0;g<e.systemNodes.length;g++){var h=e.systemNodes[g],k=h.r*Math.cos(h.t),l=h.r*Math.sin(h.t);h.v.x=d;h.v.y=f;a.lineVisibleTween&&a.lineVisibleTween.stop();
a.lineVisibleTween=(new TWEEN.Tween({x:d,y:f})).to({x:k,y:l},500).easing(TWEEN.Easing.Elastic.Out).onUpdate(function(a,b){return function(){a.v.setX(this.x);a.v.setY(this.y);b.line&&(b.line.geometry.verticesNeedUpdate=!0)}}(h,a)).start()}}else RING.scene.remove(a.line)}},800,this,a);this.line&&(b||RING.scene.remove(this.line))},createElement:function(){this.$container.html(" ");this.$title=$("<div id='title'>posted in <span class='yellow'>"+this.model.get("blog_name")+"</span></div>").appendTo(this.$container);
this.$reblogCount=$("<div id='reblog_count'>reblogged <span class='yellow'>"+this.model.reblogs.length+"</span> times</div>").appendTo(this.$container);var a=this.model.get("text");500<a.length&&(a=a.slice(0,498),a+="...");var b=this.model.get("photo");""!==b&&(this.$photo=$("<img id='photo'/>").attr("src",b).load(function(){(!this.complete||"undefined"==typeof this.naturalWidth||0==this.naturalWidth)&&alert("broken image!")}).appendTo(this.$container));""!==a&&(this.$text=$("<div id='text'>"+a+"</div>").appendTo(this.$container));
this.$notes=$("<div id='note_count'>notes: <span class='yellow'>"+this.model.get("note_count")+"</span></div>").appendTo(this.$container);this.$artists=$("<div id='artist'><span class='yellow'>#"+this.model.get("artist")+"</span></div>").appendTo(this.$container)},drawEdgeToOrigin:function(){this.line&&RING.scene.remove(this.line);var a=this.model.origin;if(a){var b=new THREE.Geometry;b.vertices.push(this.model.systemNodes[0].v);for(var c=this.model.systemNodeIndex;0<=c;c--)b.vertices.push(a.systemNodes[c].v);
this.line=new THREE.Line(b,RING.Tumblr.lineMaterial)}},remove:function(){this.line&&RING.scene.remove(this.line)}});RING.TumblrCollection=Backbone.Collection.extend({model:RING.Tumblr,initialize:function(a,b){this.on("remove",this.postRemoved);this.primary=[]},connectReblogs:function(){this.forEach(function(a,b){a.connectToReblogs()})},postRemoved:function(a){a.remove()},render:function(){},setReblogVisibility:function(a){this.forEach(function(b,c){b.setReblogVisibility(a)})},allLoaded:function(){this.forEach(function(a,b){a.allLoaded()});this.forEach(function(a,b){a.allLoaded2()});this.forEach(function(a,b){a.allLoaded3()});
this.primary=this.filter(function(a){return null===a.get("reblogged_from")})},sync:function(a){var b=window.location.origin+"get?type=tumblr",c=this;RING.dontLoad?a():$.ajax(b,{success:function(b){c.update(b);console.log("tumblr posts loaded");a()},error:function(){alert("there has been an error. try reloading the page");console.error("could not fetch that data")}})},addArtist:function(a){var b=a.artist.name;this.add(a.tumblr,{merge:!1});a=this.where({artist:b});_.forEach(a,function(a){a.allLoaded()});
_.forEach(a,function(a){a.allLoaded2()});this.primary=this.filter(function(a){return null===a.get("reblogged_from")})},updateArtist:function(a){var b=[],c=this;_.forEach(a.tumblr,function(a){var d=c.get(a.id);d?d.set({note_count:a.note_count}):(a=new RING.Tumblr(a),c.add(a),b.push(a))});_.forEach(b,function(a){a.allLoaded()});_.forEach(b,function(a){a.allLoaded2()});this.primary=this.filter(function(a){return null===a.get("reblogged_from")})},loadArtist:function(a){a=this.where({artist:a});_.forEach(a,
function(a){a.allLoaded()});_.forEach(a,function(a){null===a.get("reblogged_from")?a.positionReblogs():a.view.drawEdgeToOrigin()});this.primary=this.filter(function(a){return null===a.get("reblogged_from")})},removeAll:function(){this.forEach(function(a){a.removeAll()})}});RING.Twitter=RING.Post.extend({initialize:function(a,b){this.superInit(a,b);this.set("style","octagon");this.view=new RING.Twitter.View({model:this});this.listenTo(RING.controls,"change:startTime",this.getPositionFromTime);this.listenTo(RING.controls,"change:endTime",this.getPositionFromTime);this.on("change:visible",this.getPositionFromTime)},allLoaded:function(){this.superLoaded();var a=RING.controls.artistList.getHandle(this.get("artist"));this.set("handle",a)}});
RING.Twitter.View=RING.Post.View.extend({initialize:function(){this.superInit()},createElement:function(){this.$container.html(" ");this.$title=$("<div id='title'>posted by <span class='yellow'>@"+this.model.get("handle")+"</span></div>").appendTo(this.$container);var a=this.model.get("text");this.$text=$("<div id='tweet'>"+a+"</div>").appendTo(this.$container);this.$notes=$("<div id='note_count'>retweets: <span class='yellow'>"+this.model.get("note_count")+"</span></div>").appendTo(this.$container);
this.$artists=$("<div id='artist'><span class='yellow'>#"+this.model.get("artist")+"</span></div>").appendTo(this.$container)}});RING.TwitterCollection=Backbone.Collection.extend({model:RING.Twitter,initialize:function(a,b){this.on("add",this.postAdded);this.on("remove",this.postRemoved)},postAdded:function(a){},postRemoved:function(a){a.remove()},render:function(){},allLoaded:function(){this.forEach(function(a,b){a.allLoaded()})},sync:function(a){var b=window.location.origin+"get?type=twitter",c=this;RING.dontLoad?a():$.ajax(b,{success:function(b){c.update(b);a();console.log("twitter tweets loaded")},error:function(){alert("there has been an error. try reloading the page");
console.error("could not fetch that data")}})},addArtist:function(a){var b=a.artist.name,b=a.artist.name,c=this;_.forEach(a.twitter,function(a){var b=c.get(a.id);b?b.set({note_count:a.note_count}):c.add(a)});a=this.where({artist:b});_.forEach(a,function(a){a.allLoaded()})},updateArtist:function(a){var b=[],c=this;_.forEach(a.twitter,function(a){var d=c.get(a.id);d?d.set({note_count:a.note_count}):(a=new RING.Twitter(a),c.add(a),b.push(a))});_.forEach(b,function(a){a.allLoaded()})},loadArtist:function(a){a=
this.where({artist:a});_.forEach(a,function(a){a.allLoaded()})},removeAll:function(){this.forEach(function(a){a.removeAll()})}});RING.Artist=Backbone.Model.extend({defaults:{checked:!1,name:"",count:0,handle:"",color:[255,255,255],visible:!1,eMuze:!1,searchedFor:!1},initialize:function(a,b){this.id=this.get("name");this.view=new RING.Artist.View({model:this})}});
RING.Artist.View=Backbone.View.extend({className:"tag",events:{click:"check"},initialize:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"change:visible",this.addOrRemove);this.$checkbox=$("<div class='checkbox'></div>").appendTo(this.$el);this.$artist=$("<div class='artist'>"+this.model.get("name")+"</div>").appendTo(this.$el);this.render(this.model)},render:function(a){this.model.get("checked")?(a=this.model.get("color"),this.$checkbox.css({"background-color":"rgb("+
255*a.r+","+255*a.g+","+255*a.b+")"})):this.$checkbox.css({"background-color":"inherit"})},check:function(a){this.model.set("checked",!this.model.get("checked"))},addOrRemove:function(){this.model.get("eMuze")?this.model.get("visible")?(this.delegateEvents(),this.$el.appendTo($("#eMuzeTags"))):this.$el.remove():this.model.get("searchedFor")?this.model.get("visible")?(this.delegateEvents(),this.$el.appendTo($("#searchList"))):(this.delegateEvents(),this.$el.remove()):this.model.get("visible")?(this.delegateEvents(),
this.$el.appendTo($("#tagsList"))):(this.delegateEvents(),this.$el.remove())}});
RING.Artists=Backbone.Collection.extend({model:RING.Artist,initialize:function(a,b){this.on("add",this.added);this.on("change:checked",this.removeAll);this.topPostsLength=RING.artistCount;this.searchLength=4;this.searches=[]},comparator:function(a,b){var c=a.get("count"),e=b.get("count");return c>e?-1:c===e?0:1},added:function(a){a.get("searchedFor")?(this.searches.push(a),a.set({visible:!0}),this.searches.length>this.searchLength&&(a=this.searches.shift(),a.set({checked:!1,visible:!1}),this.remove(a))):
(a=this.filter(function(a){return!(a.get("searchedFor")||a.get("eMuze"))}),a.length>this.topPostsLength&&(a=_.last(a),a.set({checked:!1,visible:!1}),this.remove(a)),this.putInOrder())},putInOrder:function(){for(var a=this.filter(function(a){return!(a.get("searchedFor")||a.get("eMuze"))}),b=0;b<a.length;b++){var c=a[b];c.set("visible",!1)}for(b=0;b<a.length;b++)b<this.topPostsLength&&(c=a[b],c.set("visible",!0))},clearSearches:function(){for(var a=0;a<this.searches.length;a++){var b=this.searches[a];
b.set({visible:!1,checked:!1});this.remove(b)}this.searches=[]},getHandle:function(a){return this.where({name:a})[0].get("handle")},updateList:function(a){var b=this.get(a);b?b.set({count:a.get("count")}):this.add(a)},removeAll:function(){checked=this.where({checked:!0});0===checked.length&&setTimeout(function(){RING.controls.set("visiblePosts",0);RING.tumblrCollection.removeAll();RING.twitterCollection.removeAll()},1E3)}});RING.Controls=Backbone.Model.extend({defaults:{startTime:new Date((new Date).getFullYear(),(new Date).getMonth(),parseInt((new Date).getDate())-3),endTime:new Date,reblogLevel:1,expanded:!1,visiblePosts:0,loading:0,addLoaded:!1,loadingText:"",zoom:1E3},initialize:function(a,b){var c=(new THREE.Color).setRGB(40/255,170/255,225/255),e=(new THREE.Color).setRGB(158/255,65/255,195/255),d=(new THREE.Color).setRGB(1,226/255,31/255),f=(new THREE.Color).setRGB(1,48/255,49/255),g=(new THREE.Color).setRGB(151/
255,201/255,76/255);this.availableColors=[c,e,d,f,g];this.colorPointer=0;this.artistList=new RING.Artists;this.artists=[];this.listenTo(this.artistList,"change:checked",this.updateArtists);this.throttledRender=_.throttle(this.render,1E3);this.on("change:startTime",this.throttledRender);this.on("change:reblogLevel",this.throttledRender);this.on("change:allLoaded",this.allLoaded);this.view=new RING.Controls.View({model:this});this.datePicker=new RING.DatePicker({model:this});this.reblogLevel=new RING.ReblogLevel({model:this});
this.loadingScreen=new RING.LoadingScreen({model:this});this.dateIndicator=new RING.DateIndicator({model:this});this.zoom=new RING.Zoom({model:this});this.search=new RING.Search({model:this});this.loadCache();RING.installation&&setInterval(function(a){console.log("background update");a.backgroundUpdate()},36E5,this)},allLoaded:function(a,b){b&&(RING.start(),RING.attractMode.changeArtist())},updateArtists:function(a,b){if(b){if(4<this.artists.length){var c=this.artists.shift();this.availableColors.push(c.get("color"));
c.set("checked",!1)}a.set("color",this.availableColors.shift());this.setCollectionColors(a);this.artists.push(a)}else c=this.artists.indexOf(a),-1<c&&(c=this.artists.splice(c,1),this.availableColors.push(c[0].get("color")));this.throttledRender()},setCollectionColors:function(a){var b=a.get("name"),c=a.get("color");RING.tumblrCollection.forEach(function(a){a.get("artist")===b&&a.set("color",c)});RING.twitterCollection.forEach(function(a){a.get("artist")===b&&a.set("color",c)})},render:function(){for(var a=
this.artists,b=this.get("endTime"),c=this.get("startTime"),e=this.get("reblogLevel"),d=RING.tumblrCollection.primary,f=0,g=d.length;f<g;f++){for(var h=d[f],k=!1,l=0;l<a.length;l++)if(h.get("artist")===a[l].get("name")){k=!0;break}k?(k=new Date(h.get("timestamp")),(k=k>c&&k<=b)?setTimeout(function(a){a.set("visible",!0);a.makeReblogsVisible(e)},0,h):setTimeout(function(a){a.set("visible",!1)},0,h)):setTimeout(function(a){a.set("visible",!1)},0,h)}d=RING.twitterCollection.models;f=0;for(g=d.length;f<
g;f++){h=d[f];k=!1;for(l=0;l<a.length;l++)if(h.get("artist")===a[l].get("name")){k=!0;break}k?(k=new Date(h.get("timestamp")),(k=k>c&&k<=b)?setTimeout(function(a){a.set("visible",!0)},0,h):setTimeout(function(a){a.set("visible",!1)},0,h)):setTimeout(function(a){a.set("visible",!1)},0,h)}},loadeMuze:function(a){var b=this;this.loadFEEDsxsw(function(){b.loadConnecteMuze(a)})},loadFEEDsxsw:function(a){var b=window.location.origin+"/get?type=week&artist=FEEDsxsw",c=this;c.set("loadingText","Getting FEEDsxsw Posts");
$.ajax(b,{success:function(b){b=b.posts[0];c.set("loading",c.get("loading")+1);if(null!==b.artist){var d=new RING.Artist(b.artist);c.artistList.add(d,{merge:!1,silent:!0});d.set("eMuze",!0);d.set("visible",!0);RING.tumblrCollection.add(b.tumblr,{merge:!1});RING.twitterCollection.add(b.twitter,{merge:!1});RING.tumblrCollection.loadArtist(b.artist.name);RING.twitterCollection.loadArtist(b.artist.name);a()}},error:function(){console.error("could not get that artist")}})},loadConnecteMuze:function(a){var b=
window.location.origin+"/get?type=week&artist=eMuze%20Connect",c=this;c.set("loadingText","Getting eMuze Connect Posts");$.ajax(b,{success:function(b){b=b.posts[0];c.set("loading",c.get("loading")+1);if(null!==b.artist){var d=new RING.Artist(b.artist);c.artistList.add(d,{merge:!1,silent:!0});d.set("eMuze",!0);d.set("visible",!0);RING.tumblrCollection.add(b.tumblr,{merge:!1});RING.twitterCollection.add(b.twitter,{merge:!1});RING.tumblrCollection.loadArtist(b.artist.name);RING.twitterCollection.loadArtist(b.artist.name);
a()}},error:function(){console.error("could not get that artist")}})},loadCache:function(){var a=RING.installation?window.location.origin+"/get?type=cacheFull":window.location.origin+"/get?type=cache",b=this;b.set("loading",b.get("loading")+1);b.loadeMuze(function(){b.set("loadingText","Downloading Tweets and Tumblr Posts");$.ajax(a,{success:function(a){var e=a.posts;b.set("loading",b.get("loading")+1);b.set("loadingText","Fetching Artists Posts");for(a=0;a<e.length;a++)setTimeout(function(a,c){b.set("loadingText",
"Loading Aritst "+c+"/"+e.length);var g=new RING.Artist(a.artist);b.artistList.add(g,{merge:!1,silent:!0});g.set("visible",!0);RING.tumblrCollection.addArtist(a);RING.twitterCollection.addArtist(a);b.set("loading",b.get("loading")+1)},100*a,e[a],a+1)},error:function(){console.error("could not get that artist")}})})},loadArtists:function(a,b){a=encodeURIComponent(a);var c=this;$.ajax(window.location.origin+"/get?type=week&artist="+a,{success:function(e){if(null!==e.artist){var d=new RING.Artist(e.artist);
c.model.artistList.add(d,{merge:!1});RING.tumblrCollection.add(e.tumblr,{merge:!1});RING.twitterCollection.add(e.twitter,{merge:!1});RING.tumblrCollection.loadArtist(a);RING.twitterCollection.loadArtist(a);b()}},error:function(){console.error("could not get that artist")}})},backgroundUpdate:function(){this.updateeMuze();var a=this;$.ajax(RING.installation?window.location.origin+"/get?type=cacheFull":window.location.origin+"/get?type=cache",{success:function(b){b=b.posts;for(var c=0;c<b.length;c++)setTimeout(function(b){var c=
new RING.Artist(b.artist);a.artistList.updateList(c);RING.tumblrCollection.updateArtist(b);RING.twitterCollection.updateArtist(b)},3E4*c,b[c])},error:function(){console.error("could not get that artist")}})},updateeMuze:function(){var a=window.location.origin+"/get?type=week&artist=eMuze%20Connect";this.set("loadingText","Getting eMuze Connect Posts");$.ajax(a,{success:function(a){a=a.posts[0];RING.tumblrCollection.updateArtist(a);RING.twitterCollection.updateArtist(a)}});a=window.location.origin+
"/get?type=week&artist=FEEDsxsw";this.set("loadingText","Getting eMuze Connect Posts");$.ajax(a,{success:function(a){a=a.posts[0];RING.tumblrCollection.updateArtist(a);RING.twitterCollection.updateArtist(a)}})}});
RING.Controls.View=Backbone.View.extend({className:"controls",initialize:function(){this.setElement($("#controls"));this.$loading=$("<div id=loading>LOADING</div>").appendTo(this.$el);this.$revealButton=$("<div id='revealButton'><span class='titleText'>SHOW OPTIONS</span></div>").appendTo($("#container"));this.$revealButton.click(this.changeExpand.bind(this));this.$dateRange=$("#dateRange");this.$reblogLevel=$("#reblogDisplay");this.$visiblePosts=$("#visiblePosts");this.listenTo(this.model,"change",
_.throttle(this.render,100));this.listenTo(this.model,"change:expanded",this.expand);this.render(this.model);RING.installation||(this.$visitEmuze=$("<div id='visitEmuze'><span class='titleText'>VISIT EMUZE</span></div>").insertAfter($("#controls")),this.$visitEmuze.click(function(){window.open("http://www.emuze.com","_blank")}))},render:function(a){a=this.model.get("startTime");var b=this.model.get("endTime");a=a.getMonthName()+" "+a.getDate();b=b.getMonthName()+" "+b.getDate();switch(this.model.get("reblogLevel")){case 0:this.$reblogLevel.html("<span class='titleText'>DISPLAYING:</span><span class='titleText purpleText'>PRIMARY POSTS</span>");
break;case 1:this.$reblogLevel.html("<span class='titleText'>DISPLAYING:</span><span class='titleText purpleText'>PRIMARY POSTS</span><span class='titleText'>AND</span><span class='titleText purpleText'>REBLOGS</span>");break;case 2:this.$reblogLevel.html("<span class='titleText'>DISPLAYING:</span><span class='titleText purpleText'>PRIMARY POSTS</span><span class='titleText'>AND</span><span class='titleText purpleText'>REBLOGS OF REBLOGS</span>")}var c=this.model.get("visiblePosts");this.$visiblePosts.html(c);
this.$dateRange.html(a+" TO "+b)},changeExpand:function(){this.model.set("expanded",!this.model.get("expanded"))},expand:function(a,b){var c=this;b?(this.$el.css({width:"5px"}),RING.installation?this.$el.transition({height:"1000px"},500,function(){$(this).transition({width:"400px"},500,function(){c.render();c.model.datePicker.render();c.model.reblogLevel.render()})}):$("#visitEmuze").hide(250,function(){c.$el.transition({height:"1000px"},500,function(){$(this).transition({width:"400px"},500,function(){c.render();
c.model.datePicker.render();c.model.reblogLevel.render()})})}),this.$revealButton.find("span").html("HIDE OPTIONS")):(this.$el.stop().transition({width:"5px"},500,function(){$(this).transition({height:"0px"},500,function(){RING.installation||$("#visitEmuze").show(250)})}),this.$revealButton.find("span").html("SHOW OPTIONS"))}});
RING.DatePicker=Backbone.View.extend({className:"datePicker",events:{slide:"changeDate"},initialize:function(){this.$title=$("<div id='title' class='titleText'>DATE RANGE</div>").appendTo(this.$el);this.$slider=$("<div id='slider'></div>").appendTo(this.$el);this.$range=$("<div id='range'></div>").appendTo(this.$slider);this.$el.appendTo($("#controls"));this.listenTo(this.model,"change:startTime",this.render);this.listenTo(this.model,"change:endTime",this.render);this.$dots=[];for(var a=0;4>=a;a++){var b=
25*a,c=$("<div class='dot'></div>").appendTo(this.$slider);c.css({left:b+"%"});this.$dots.push(c)}this.$dates=[];for(a=0;4>=a;a++)b=25*a,c=$("<div class='date'>0</div>").appendTo(this.$slider),c.css({left:b+"%"}),this.$dates.push(c);this.render(this.model)},render:function(a){a=new Date;var b=this.model.get("startTime"),c=this.model.get("endTime"),b=Math.ceil((b-a)/864E5),c=Math.ceil((c-a)/864E5);this.$slider.slider({range:!0,min:-4,max:0,values:[b,c]});var c=this.$el.find(".ui-slider-range"),e=c.css("left"),
c=c.css("width");this.$range.css({left:e,width:c});for(var e=parseInt(e),c=parseInt(c),d=e+c,c=0;c<this.$dots.length;c++){var b=this.$dots[c],f=b.css("left"),f=parseInt(f);f>=e&&f<=d?b.css({"background-color":"#9E41C3"}):b.css({"background-color":"#fff"})}for(c=0;c<this.$dates.length;c++)b=this.$dates[c],d=new Date(a.getFullYear(),a.getMonth(),a.getDate()+(c-4)),e=d.getMonth()+1,d=d.getDate(),b.html(e+"/"+d)},changeDate:function(a,b){var c=new Date,e=new Date(c.getFullYear(),c.getMonth(),parseInt(c.getDate())+
b.values[0]),c=0===b.values[1]?new Date:new Date(c.getFullYear(),c.getMonth(),parseInt(c.getDate())+b.values[1]);this.model.set({startTime:e,endTime:c})}});
RING.DateIndicator=Backbone.View.extend({className:"dateIndicator",initialize:function(){this.$dates=[];for(var a=0;5>a;a++){var b=$("<div class='dateNumber date'>3/4</div>").appendTo(this.$el);$("<div class='dateNumber '>3</div>").appendTo(this.$el);$("<div class='dateNumber'>0</div>").appendTo(this.$el);b=$("<div class='dateNumber'>0</div>").appendTo(this.$el);this.$dates.push(b)}this.$el.transition({scale:0.8});this.$el.appendTo($("#container"));this.render(this.model);this.listenTo(this.model,
"change:startTime",this.render);this.listenTo(this.model,"change:endTime",this.render);this.listenTo(this.model,"change:zoom",this.zoom)},render:function(a){this.$el.html(" ");a=this.model.get("startTime");for(var b=(this.model.get("endTime")-a)/864E5,c=1>b?Math.ceil(8*b):8*Math.floor(b),e=0;e<c;e++){var d;switch(e%8){case 0:d=parseInt(a.getDate())+e/8;var f=parseInt(a.getMonth())+1;d=$("<div class='dateNumber date'>"+f+"/"+d+"</div>").appendTo(this.$el);break;case 1:d=$("<div class='dateNumber tertiary'>3a</div>").appendTo(this.$el);
break;case 2:d=$("<div class='dateNumber secondary'>6a</div>").appendTo(this.$el);break;case 3:d=$("<div class='dateNumber tertiary'>9a</div>").appendTo(this.$el);break;case 4:d=$("<div class='dateNumber primary'>12p</div>").appendTo(this.$el);break;case 5:d=$("<div class='dateNumber tertiary'>3p</div>").appendTo(this.$el);break;case 6:d=$("<div class='dateNumber secondary'>6p</div>").appendTo(this.$el);break;case 7:d=$("<div class='dateNumber tertiary'>9p</div>").appendTo(this.$el)}var g=2*e/c*Math.PI-
Math.PI/2,f=180*Math.sin(g)+350,g=180*Math.cos(g)+350;d.css({top:f,left:g})}switch(Math.floor(b)){case 4:this.$el.find(".primary").remove();case 3:this.$el.find(".secondary").remove();case 2:this.$el.find(".tertiary").remove()}},zoom:function(a,b){this.$el.stop().transition({scale:0.8*(1E3/b)},1200)}});
RING.ReblogLevel=Backbone.View.extend({className:"reblogLevel",events:{slide:"changeVisibility"},initialize:function(){this.listenTo(this.model,"change:reblogLevel",this.render);this.$title=$("<div id='title' class='titleText'>REBLOG LEVEL</div>").appendTo(this.$el);$("<div id='notes'><div id='primary'>PRIMARY</div><div id='reblogs'>REBLOGS</div><div id='reblogreblogs'>REBLOGS OF REBLOGS</div></div>").appendTo(this.$el);this.$slider=$("<div id='slider'></div>").appendTo(this.$el);this.$range=$("<div id='range'></div>").appendTo(this.$slider);
this.$el.appendTo($("#controls"));this.$dots=[];for(var a=0;2>=a;a++){var b=50*a,c=$("<div class='dot'></div>").appendTo(this.$slider);c.css({left:b+"%"});this.$dots.push(c)}this.render(this.model)},render:function(a){a=this.model.get("reblogLevel");this.$slider.slider({min:0,max:2,value:a,range:"min"});var b=this.$el.find(".ui-slider-range");a=b.css("left");b=b.css("width");this.$range.css({left:a,width:b});a=parseInt(a);for(var b=parseInt(b),b=a+b,c=0;c<this.$dots.length;c++){var e=this.$dots[c],
d=e.css("left"),d=parseInt(d);d>=a&&d<=b?e.css({"background-color":"#9E41C3"}):e.css({"background-color":"#fff"})}},changeVisibility:function(a,b){this.model.set("reblogLevel",b.value)}});
RING.Search=Backbone.View.extend({className:"search",events:{"click #button":"searchArtist"},initialize:function(){this.$title=$("<div id='title' class='titleText'>SEARCH FOR AN SXSW ARTIST</div>").appendTo(this.$el);this.$search=$("<input class='titleText' id='search'/>").appendTo(this.$el);this.$button=$("<div class='titleText' id='button'>SEARCH</div>").appendTo(this.$el);this.$el.insertAfter($("#tags"));this.getAutoCompleteList()},getAutoCompleteList:function(a){var b=this;$.ajax(window.location.origin+
"/get?type=artists",{success:function(a){console.log("got auto complete");b.addAutoComplete(a)},error:function(){console.error("could not get autocomplete list")}})},addAutoComplete:function(a){this.$search.autocomplete({source:a})},searchArtist:function(){var a=this.$search.val();this.$search.val("");var b=this.model.artistList.where({name:a});if(0<b.length)b[0].set("checked",!0);else{var a=encodeURIComponent(a),c=this;$.ajax(window.location.origin+"/get?type=week&artist="+a,{success:function(a){console.log("got artist");
a=a.posts[0];if(null!==a.artist){var b=new RING.Artist(a.artist);b.set("searchedFor",!0);c.model.artistList.add(b);RING.tumblrCollection.addArtist(a);RING.twitterCollection.addArtist(a);b.set("checked",!0)}},error:function(){console.error("could not get that artist")}})}}});
RING.LoadingScreen=Backbone.View.extend({className:"loadingScreen",events:{"click .loaded":"begin"},initialize:function(){this.$loadingArea=$("#loadedArea");this.$loadingText=$("#loadingText");this.setElement($("#loadingBar"));this.listenTo(this.model,"change:loadingText",this.updateText);this.listenTo(this.model,"change:loading",this.updateProgress)},updateText:function(a,b){this.$loadingText.html(b)},updateProgress:function(a,b){var c=Math.round(100*(b/(RING.artistCount+4))),c=c+"%";this.$loadingArea.css({width:c});
"100%"===c&&(this.model.set("allLoaded",!0),this.updateText(this.model,"BEGIN"),this.$el.addClass("begin").transition({width:"126px"},200).click(this.begin.bind(this)))},begin:function(){var a=this.model;$("#loadingScreen").transition({width:"0px"},200,function(){$(this).css({"z-index":-1E3});RING.installation||a.set("expanded",!0);RING.sound.set("started",!0)})}});
RING.Zoom=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change:zoom",this.zoom);this.listenTo(this.model,"change:visiblePosts",_.throttle(this.getZoom,800))},zoom:function(a,b){this.zoomTween&&this.zoomTween.stop();this.zoomTween=(new TWEEN.Tween({z:RING.camera.position.z})).to({z:b},1200).easing(TWEEN.Easing.Exponential.Out).onUpdate(function(){RING.camera.position.setZ(this.z)}).start()},getZoom:function(){var a=RING.tumblrCollection.max(function(a){return a.get("visible")?
a.get("radius"):0}),a=280*Math.log(a.get("radius")/10),a=Math.max(1E3,a);this.model.set("zoom",a)}});Date.prototype.monthNames="January February March April May June July August September October November December".split(" ");Date.prototype.getMonthName=function(){return this.monthNames[this.getMonth()]};RING.AttractMode=Backbone.Model.extend({defaults:{lastTouch:new Date,attractMode:!1},initialize:function(a,b){RING.$container.mousemove(this.touched.bind(this));this.on("change:attractMode",this.changeAttract);this.on("change:lastTouch",this.testAttractMode);this.listenTo(RING.controls,"change:allLoaded",this.allLoaded)},touched:function(){this.set("lastTouch",new Date)},allLoaded:function(){this.set("lastTouch",new Date);setInterval(this.testAttractMode.bind(this),1E4)},testAttractMode:function(){var a=
this.get("lastTouch");6E4<new Date-a?this.set("attractMode",!0):this.set("attractMode",!1)},changeAttract:function(a,b){RING.controls.set("expanded",!1);RING.controls.artistList.clearSearches();this.attract()},attract:function(){this.get("attractMode")&&(RING.removeHighlight(),RING.Util.choose([this.changeTime,this.changeArtist,this.showPopOver,this.showPopOver,this.showPopOver,this.showPopOver,this.changeReblogLevel])(),setTimeout(this.attract.bind(this),RING.Util.randomInt(5E3,8E3)))},changeTime:function(){var a=
new Date,b=RING.Util.randomInt(0,5),c=RING.Util.randomInt(0,4);if(b<c)var e=b,b=c,c=e;else b===c&&(0<c?c--:b++);b=new Date(a.getFullYear(),a.getMonth(),parseInt(a.getDate())-b);a=new Date(a.getFullYear(),a.getMonth(),parseInt(a.getDate())-c);RING.controls.set({startTime:b,endTime:a})},changeArtist:function(){var a=RING.controls.artistList.filter(function(a){return!(a.get("searchedFor")||a.get("eMuze"))}),a=RING.Util.choose(a);a.set("checked",!a.get("checked"))},showPopOver:function(){var a=RING.tumblrCollection.where({visible:!0});
a.concat(RING.twitterCollection.where({visible:!0}));if(a=RING.Util.choose(a)){var b=RING.width/2,c=RING.height/2,e=(new THREE.Projector).projectVector(new THREE.Vector3(a.get("x"),a.get("y"),0),RING.camera);e.x=e.x*b+b;e.y=-(e.y*c)+c;a.clicked(e.x,e.y)}},changeReblogLevel:function(){RING.controls.set("reblogLevel",RING.Util.randomInt(0,3))}});RING.Sound=Backbone.Model.extend({defaults:{loaded:0,playable:!1,started:!1},initialize:function(a,b){if(Modernizr.webaudio){this.context=new webkitAudioContext;this.makeColors();this.files="in0 in1 in2 in3 in4 out0 out1 out2 out3 out4".split(" ");this.inBuffer=[];this.outBuffer=[];for(var c=0;c<this.files.length;c++)this.loadBuffer(this.files[c],5>c?this.inBuffer:this.outBuffer,c%5);c=_.throttle(this.soundModel,100);this.listenTo(RING.tumblrCollection,"change:visible",c);this.listenTo(RING.twitterCollection,
"change:visible",c);this.on("change:loaded",this.canPlay);this.on("change:started",this.canPlay);this.output=this.context.createGain();this.compressor=this.context.createDynamicsCompressor();this.output.connect(this.compressor);this.compressor.connect(this.context.destination);this.output.gain.value=0}},makeColors:function(){var a=(new THREE.Color).setRGB(40/255,170/255,225/255),b=(new THREE.Color).setRGB(158/255,65/255,195/255),c=(new THREE.Color).setRGB(1,226/255,31/255),e=(new THREE.Color).setRGB(1,
48/255,49/255),d=(new THREE.Color).setRGB(151/255,201/255,76/255);this.colors=[a,c,b,e,d]},loadBuffer:function(a,b,c){var e=new XMLHttpRequest;e.open("GET","./audio/"+a+".mp3",!0);e.responseType="arraybuffer";var d=this;e.onload=function(a){d.context.decodeAudioData(e.response,function(a){d.set("loaded",d.get("loaded")+1);b[c]=a})};e.send()},canPlay:function(a){this.get("started")&&this.get("loaded")===this.files.length&&(this.set("playable",!0),this.output.gain.value=1)},soundModel:function(a,b){if(this.get("playable")){var c=
this.context.createBufferSource(),e=RING.Util.scaleExp(a.get("size"),10,60,0,1),e=Math.min(e,1),d=this.context.createGainNode();d.gain.value=e;c.connect(d);e=this.context.createPanner();e.setPosition(a.get("x")/200,a.get("y")/200,0);d.connect(e);e.connect(this.output);d=this.indexFromColor(a);b?0<=d&&(c.buffer=this.inBuffer[d]):0<=d&&(c.buffer=this.outBuffer[d]);c.start(0.2)}},indexFromColor:function(a){a=a.get("color");for(var b=0;b<this.colors.length;b++){var c=this.colors[b];if(a.r===c.r&&a.g===
c.g&&a.b===c.b)return b}return-1}});
