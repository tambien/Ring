var Twit = require('twit');
var keys = require('../keys');
var artists = require('../artists');
var db = require('./twitter-db');

/*
 * TWITTER
 */
( function() {

	//the connection with twitter
	var Twitter = new Twit({
		consumer_key : keys.twitterCustomerKey,
		consumer_secret : keys.twitterCustomerSecret,
		access_token : keys.twitterAccessToken,
		access_token_secret : keys.twitterAccessTokenSecret,
	});

	var results = {
		fetched : 0,
		put : 0,
		updated : 0,
	}

	//var handles = ["23499568", "515950015", "205607946", "40086300", "619549983", "5248441", "202897422", "18124954", "16736552", "125465007", "595589439", "755188758", "63376519", "29844055", "104128722", "100993322", "80706281", "4075231", "181589093", "19824362", "257444834", "18156110", "57514143", "69489016", "342303909", "143625600", "35604952", "20869688", "771308160", "26344187", "226965240", "242490237", "26443701", "26187377", "166367383", "130294557", "39095494", "9462292", "148880182", "25879140", "15869814", "301931359", "13793452", "18785334", "995465244", "49093871", "66801268", "22588079", "260052525", "129646411", "188942429", "58133585", "45887489", "16116337", "462453969", "21056214", "898071936", "208933932", "633513177", "182956737", "361645310", "179599033", "42744294", "21268095", "26859445", "232418772", "47708027", "624844989", "832705460", "803282208", "112833733", "112310382", "38638456", "36772266", "265610640", "115861974", "73124555", "321537025", "145394793", "39770794", "288278111", "346674614", "755188758", "15437723", "20985035", "848380963", "15040597", "124260591", "41525825", "117539097", "9782492", "193575342", "125276161", "58043272", "134122819", "23657830", "312753460", "290059428", "25111579", "378414581", "44692601", "566763294", "89386654", "19145032", "219059870", "339878467", "84373134", "393080262", "55046026", "99196757", "51918275", "24327133", "392834170", "77204591", "9447532", "37772514", "128000570", "58583749", "22203288", "30452129", "15751732", "22312032", "207995483", "93366621", "24638518", "579643916", "54872931", "151331203", "53496813", "73051839", "144983193", "16714519", "304579081", "19867571", "42168116", "41612072", "41295430", "13496142", "352086866", "29036494", "16258737", "40755409", "195489617", "19552745", "40867079", "255788251", "252868037", "68850686", "94136569", "22120740", "60662346", "862470600", "46136918", "18158843", "298254602", "96631484", "202740948", "22553596", "73014758", "14270870", "168913538", "418404991", "180106832", "247548648", "550240211", "280688893", "54200533", "25357719", "23412291", "127050146", "66204407", "18918712", "125741726", "23094967", "152060185", "12657132", "48925018", "18016384", "66995579", "77820247", "28180089", "952955946", "21050859", "23604791", "974687466", "585329053", "158082609", "546419620", "25700550", "66421149", "69741398", "170828891", "23937259", "64402154", "106021974", "48931481", "23826861", "28029603", "309712002", "220261517", "21199482", "1026482220", "108130490", "88249280", "158430828", "82793759", "16186949", "133468921", "119084565", "42790388", "21319713", "90956649", "932711989", "519173886", "447232518", "18923343", "179700657", "220708504", "183075111", "573805486", "24945640", "379999607", "19402785", "126211854", "27427113", "90918200", "44491023", "125081875", "302039327", "858488426", "84644205", "83887991", "183234712", "20499828", "181572333", "95423948", "52759858", "209485378", "103012173", "37843437", "167711000", "441475031", "49407507", "34295932", "278735890", "119212115", "151547056", "102109571", "19159544", "51404605", "267057927", "284032082", "43945725", "59759197", "10403", "195951022", "23220103", "16674308", "10230192", "15679126", "71727158", "411491744", "23675921", "19482720", "123988208", "305699865", "90307156", "27774100", "270176841", "83177874", "869735538", "438897828", "16096942", "58751904", "26217318", "18749977", "137463591", "329643906", "35944242", "15187314", "119709295", "14340657", "140211125", "166715703", "809656441", "33366200", "164708961", "24341323", "33926105", "75009335", "103041302", "620898875", "830976828", "30345749", "385198092", "213512367", "18471729", "34305631", "406580864", "16550220", "38089184", "128816639", "15291615", "245129157", "15900583", "204204159", "389643008", "98659923", "14147281", "123131005", "1205698574", "194605845", "297469364", "30016700", "17229626", "28627259", "372192788", "19931240", "35350274", "522232927", "23599374", "292626960", "703132742", "21879856", "14376120", "77250074", "534303511", "106533785", "17210326", "25205699", "20954761", "255725273", "22057388", "155997251", "19438795", "47484922", "85657972", "18178524", "35437174", "154636679", "43951747", "237060374", "262010306", "168643972", "14150137", "317243463", "267432884", "14974106", "266311795", "23412217", "63010198", "39727884", "111371984", "155705841", "49455149", "16454070", "89821269", "19850057", "505909674", "20588927", "386740425", "17630074", "111515085", "168954641", "22904933", "32289302", "173504992", "16663317", "240623376", "226966085", "15644916", "19520983", "24964967", "69500983", "326889905", "557353713", "20422579", "618716605", "42473495", "18802170", "17624688", "26612940", "43556421", "26646976", "36676490", "537389287", "18398695", "34714456", "123810584", "40322965", "18232069", "20578760", "17926625", "39306925", "378990560", "147110940", "61327114", "21118970", "329529724", "20066066", "22108797", "19253622", "26909323", "617223133", "27706379", "52790327", "108433037", "27109585", "16596589", "32910267", "175066174", "18639507", "19120563", "354860056", "413878059", "327138647", "59825496", "151542147", "372564369", "882945397", "486955518", "498882876", "417356449", "37957617", "33633793", "37456669", "537836045", "240000498", "193115430", "1020626100", "257705553", "1177182890", "111397022", "23511567", "17598509", "1022561774", "23229606", "14754932", "21054053", "492349143", "151544797", "537327238", "55675318", "76272296", "188629834", "170076789", "77985887", "216839761", "82776056", "274192986", "44190928", "81893181", "46253870", "603560654", "257436924", "86965067", "86357173", "21511282", "303595809", "46222199", "32957019", "194092449", "46449134", "27296456", "73191113", "221467570", "67164062", "34154689", "97583608", "78330784", "18808895", "568498043", "58526461", "18248716", "17643683", "57301115", "534506051", "193333348", "188245869", "68763748", "30762078", "15156705", "28454643", "80120512", "17997227", "30562504", "74040952", "296461236", "260465199", "62206127", "40492695", "29891110", "194462039", "18434110", "84322252", "786932160", "342196261", "17116964", "89094679", "86960703", "19741818", "95722246", "83094674", "224129081", "121347988", "29494645", "18159470", "301058026", "30513101", "24926413", "37689339", "159991253", "247053106", "34687638", "914593356", "150105676", "58103937", "27097473", "204449828", "38405053", "322997802", "115704772", "57737794", "173941078", "13962772", "60905888", "475244611", "53077928", "199315235", "83333300", "177627643", "408549622", "22967906", "69044183", "165881978", "415194563", "297617327", "14580197", "25237002", "14965611", "266460393", "235025989", "15757882", "222203693", "632279324", "322764946", "22642974", "78692051", "221188739", "23829690", "51997855", "51337479", "203742153", "1099376989", "32630596", "250860572", "22165295", "29821220", "384939199", "40203571", "33805005", "36490240", "25852151", "498525627", "23901269", "299954709", "113698496", "60102709", "189346268", "20427275", "15667155", "112833037"]

	//the stream object
	var stream = Twitter.stream('statuses/filter', {
		follow : [],
	})

	stream.on('tweet', function(tweet) {

	});
	function refreshHandles(callback) {
		//print the tweet counter

		//reset the tweet counter
		stream.stop();
		//the stream object
		stream = Twitter.stream('statuses/filter', {
			follow : artists.getHandles(),
		})
		stream.on('tweet', function(tweet) {
			results.fetched++;
			insertToDB(tweet, function(status) {
				switch (status) {
					case 'insert':
						results.put++;
						break;
					case 'update':
						results.updated++;
						break;
					default:
						break;
				}
			});
		});
		callback();
	}

	//parse the post into a useable format
	function parseTweet(tweet) {
		//if the artist is not the original poster
		var artist = artists.getArtistFromHandleID(tweet.user.id_str);
		//then it's a retweet of an artist
		if(artist === null && tweet.retweeted_status) {
			//in which case parse the original tweet
			tweet = tweet.retweeted_status;
			artist = artists.getArtistFromHandleID(tweet.user.id_str);
		}
		var id = tweet.id_str;
		var timestamp = tweet.created_at;
		var text = tweet.text.removeInvalidChars();
		var retweets = tweet.retweet_count;
		var tweet = {
			artist : artist,
			id : id,
			timestamp : timestamp,
			text : text,
			note_count : retweets,
		}
		if(artist !== null) {
			return tweet;
		} else {
			return null;
		}
	}

	//insert the post into the database
	function insertToDB(tweet, callback) {
		var parsed = parseTweet(tweet);
		if(parsed !== null) {
			db.put(parsed, callback);
		} else {
			callback();
		}
	}

	//API//////////////////////////////////////////////////////////////////////

	module.exports.refreshHandles = refreshHandles;

}())

String.prototype.removeInvalidChars = function() {
	//this gets rid of people putting emojis in their posts
	return this.replace(/[^\u0000-\u27FF]/g, '')
}